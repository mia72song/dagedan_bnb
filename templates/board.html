{% extends "admin_base.html" %}
{% block title %}Board{% endblock %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href={{ url_for("static", filename="css/board.css") }}>
    <script type="text/javascript" src={{ url_for("static", filename="js/room.js") }}></script>
    <script type="text/javascript" src={{ url_for("static", filename="js/calendar.js") }}></script>
{% endblock %}
{% block content %}
    <main>
        <div id="banner">
            <!--由Banner組件渲染-->
        </div>
        <hr>
        <div id="board">
            <!--由Board組件渲染-->
        </div>        
    </main>
    <script type="text/babel">
        class Banner extends React.Component{
            render(){
                // console.log(this.props);
                return(
                    <div>
                        <div className="title">登入成功，{this.props.name} 你好</div>
                        <div className="menu"><a href="" onClick={this.logout}>登出</a></div>
                    </div>
                )
            }
            logout=(eObj)=>{
                eObj.preventDefault();
                userRequest("DELETE").then(resp=>{
                    // console.log(resp)
                    if(resp.ok){
                        location.href = `${window.origin}/admin/`
                    }
                })
            }
        }
        class Board extends React.Component{
            state = {
                rooms: [],
                page: 0,
                y: "2021",
                m: "12",
                week: [],
                booked: []
            }
            componentDidMount(){
                roomRequest().then(resp=>{
                    this.setState({rooms: resp.data});
                    this.updateWeeklyCalendar(0);
                })
            }
            render(){
                let prvPage = <a href="#">歷史訂單</a>;
                if(this.state.page!==0){
                    prvPage = <a href="javascript: void(0)" onClick={this.toNextPage(-1)}>上週</a>;
                }
                const week = this.state.week;
                const rooms = this.state.rooms;
                const booked = this.state.booked;
                let calendar_content = [];
                let row_content = [];
                if(week.length>0 && rooms.length>0){
                    calendar_content = week.map(day=><Day key={day.date} data={day} />)
                    row_content = rooms.map(r=><Row key={r.room_no} room={r} week={week} booked={booked}/>)
                    if(booked.length>0){
                        booked.forEach(b=>{
                            ReactDOM.render(<OrderLink id={b.oid} info={b}/>, document.getElementById(b.bid));
                            console.log("渲染OrderLink");
                        })
                    }
                }
                console.log("渲染Board");
                return(
                    <table>
                        <thead>
                            <tr>
                                <th colspan="9"><h1>{this.state.y} 年 - {this.state.m} 月</h1></th>
                            </tr>
                            <tr>
                                <th id="page">
                                    {prvPage}
                                </th>
                                { calendar_content }
                                <th id="page">
                                    <a href="javascript: void(0)" onClick={this.toNextPage(1)}>下週</a>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            { row_content }
                        </tbody>
                    </table>
                )
            }            
            toNextPage=(number)=>{
                return(eObj=>{
                    let page = this.state.page+number;
                    this.updateWeeklyCalendar(page);
                })
            }
            updateWeeklyCalendar=(page)=>{
                let start_date_string = getDateString(page*7)
                let end_date_string = getDateString(page*7+6)
                getWeeklyCalendar(start_date_string).then(respC=>{
                    let week = respC.data;
                    let y = week[0].date.substring(0,4)
                    let m = week[0].date.substring(5,7)
                    this.setState({
                        page,
                        y,
                        m,
                        week
                    })
                    getBookingListWithAuth(start_date_string, end_date_string).then(respB=>{
                        if(respB.data){
                            const booked = respB.data;
                            this.setState({booked});
                        }
                    })
                })
            }
        }
        class Day extends React.Component{
            render(){
                let holiday_class = null;
                if(this.props.data.is_holiday){
                    holiday_class = "holiday"
                }
                let d = ((this.props.data.date).split("-"))[2]
                return(
                    <th className={holiday_class}>
                        <h2>{d}</h2>
                        <p>{this.props.data.weekday}</p>
                        <p id="note">{this.props.data.note}</p>
                    </th>
                )

            }
        }
        class Row extends React.Component{
            render(){                
                const room = this.props.room;
                const week = this.props.week;
                let week_content = [];
                week.forEach(d => {
                    let a_tag = document.querySelector(".order_link");
                    if(a_tag){
                        console.log("移除a tag")
                        a_tag.remove();
                    }
                    let id = d.date+"-"+room.room_no
                    let td = <td id={id} onClick={this.handleClick}></td>
                    week_content.push(td);               
                });
                console.log("Row渲染");
                return(
                    <tr className="row">
                        <td>{room.name}-{room.room_no}</td>
                        { week_content }
                        <td><button>修改</button></td>
                    </tr>
                )
            }
            handleClick=(eObj)=>{
                console.log(eObj.target.id);
            }
        }
        class OrderLink extends React.Component{
            render(){
                // console.log(this.props.info);
                const b = this.props.info;
                console.log("OrderLink組件渲染");
                return(
                    <a href="#" className="order_link">
                        <p>{b.booker_name}{b.gender}</p>
                        <p>{b.phone}</p>
                    </a>
                )
            }
        }
        addEventListener("load", ()=>{
            currentUserPromise.then(currentUser=>{
                // console.log(currentUser)
                if(currentUser==null){
                    location.href = `${window.origin}/admin`
                }else{
                    ReactDOM.render(<Banner user={currentUser[0]} name={currentUser[1]}/>, document.querySelector("#banner"));
                    ReactDOM.render(<Board/>, document.querySelector("#board"));
                }
            })
        })
                
    </script>
{% endblock %}