{% extends "admin_base.html" %}
{% block title %}Board{% endblock %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href={{ url_for("static", filename="css/board.css") }}>
    <script type="text/javascript" src={{ url_for("static", filename="js/room.js") }}></script>
    <script type="text/javascript" src={{ url_for("static", filename="js/calendar.js") }}></script>
{% endblock %}
{% block content %}
    <main>
        <div id="banner">
            <!--由Banner組件渲染-->
        </div>
        <hr>
        <div id="board">
            <!--由Board組件渲染-->
        </div>        
    </main>
    <script type="text/babel">
        class Banner extends React.Component{
            render(){
                // console.log(this.props);
                return(
                    <div>
                        <div className="title">登入成功，{this.props.name} 你好</div>
                        <div className="menu"><a href="" onClick={this.logout}>登出</a></div>
                    </div>
                )
            }
            logout=(eObj)=>{
                eObj.preventDefault();
                userRequest("DELETE").then(resp=>{
                    // console.log(resp)
                    if(resp.ok){
                        location.href = `${window.origin}/admin/`
                    }
                })
            }
        }
        class Board extends React.Component{
            state = {
                room_list:[],
                page:0,
                date_list:[],
                yyyy_mm:"",
                booking_list:[]
            }
            componentDidMount(){
                roomRequest().then(resp=>{
                    this.setState({room_list: resp.data})
                })
                this.updateDateList(this.state.page);
            }
            createBookingElement=(room, week)=>{
                let book_content = [];
                room.forEach(r=>{
                    book_content.push(
                        <tr>
                            <td>{r.name}-{r.room_no}</td>
                            <td onClick={this.handleClick} id={week[0].date+"-"+r.room_no} className="bdate"></td>
                            <td onClick={this.handleClick} id={week[1].date+"-"+r.room_no} className="bdate"></td>
                            <td onClick={this.handleClick} id={week[2].date+"-"+r.room_no} className="bdate"></td>
                            <td onClick={this.handleClick} id={week[3].date+"-"+r.room_no} className="bdate"></td>
                            <td onClick={this.handleClick} id={week[4].date+"-"+r.room_no} className="bdate"></td>
                            <td onClick={this.handleClick} id={week[5].date+"-"+r.room_no} className="bdate"></td>
                            <td onClick={this.handleClick} id={week[6].date+"-"+r.room_no} className="bdate"></td>
                            <td><a href="">修改</a></td>
                        </tr>
                    )
                })
                return book_content
            }
            render(){
                let prv_page = "< 上週"; 
                if(this.state.page===0){ prv_page = "歷史訂單" };
                
                const week = this.state.date_list;
                const room = this.state.room_list;               
                let week_content = [];
                let book_content = [];
                if(week.length>0 & room.length>0){
                    book_content = this.createBookingElement(room, week);
                    
                    week.forEach(date=>{
                        let holiday_class = null;
                        if(date.is_holiday){ holiday_class="holiday" };

                        week_content.push(
                            <th className={holiday_class}>
                                <h2>{date.date.slice(8, 11)}</h2>
                                <p>{date.weekday}</p>
                                <p id="note">{date.note}</p>
                            </th>
                        )
                    })
                }
                return(
                    <table>
                        <thead>
                            <tr>
                                <th colspan="9"><h1>{this.state.yyyy_mm}</h1></th>
                            </tr>
                            <tr>
                                <th id="page">
                                    <a href="javascript: void(0)" onClick={this.getPage(-1)}>{prv_page}</a>
                                </th>
                                {week_content}
                                <th id="page">
                                    <a href="javascript: void(0)" onClick={this.getPage(1)}>下週 ></a>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {book_content}
                        </tbody>
                    </table>
                )
            }
            updateDateList=(page)=>{
                let start_date_string = getDateString(page*7);
                let end_date_string = getDateString(page*7+6);
                getCalendar(start_date_string).then(respC=>{
                    getBookingList(start_date_string, end_date_string).then(respB=>{
                        this.setState({
                            date_list: respC.data,
                            yyyy_mm: start_date_string.slice(0, 7),
                            booking_list: respB.data
                        })
                        this.updateBooking();
                    })
                })
            }
            updateBooking=()=>{
                let items = document.querySelectorAll(".item");
                if(items){
                    items.forEach(i=>{
                        i.remove();
                    })
                }
                const booking_list = this.state.booking_list;
                let id;
                if(booking_list.length>0){
                    booking_list.forEach(b=>{
                        id = b[0]+"-"+b[1]
                        let th = document.getElementById(id);
                        let item = document.createElement("a");
                        item.setAttribute("class", "item");
                        // item.setAttribute("href", "javascript: void(0)");
                        item.textContent = b[2];
                        th.appendChild(item);
                    })
                }                
            }
            handleClick=(eObj)=>{
                console.log(eObj.target.id);
            }
            
            getPage=(number)=>{
                return(eObj=>{
                    const page = this.state.page;
                    if(page+number<0){
                        location.href = `${window.origin}/admin/booking`
                    }else{
                        this.setState({page:page+number})
                        this.updateDateList(page+number)
                    }
                })
            }
        }
       
        addEventListener("load", ()=>{
            currentUserPromise.then(currentUser=>{
                // console.log(currentUser)
                if(currentUser==null){
                    location.href = `${window.origin}/admin`
                }else{
                    ReactDOM.render(<Banner user={currentUser[0]} name={currentUser[1]}/>, document.querySelector("#banner"));
                    ReactDOM.render(<Board/>, document.querySelector("#board"));
                }
            })
        })
        
    </script>
{% endblock %}