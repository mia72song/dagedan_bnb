{% extends "base.html" %}
{% block title %}Booking Calendar{% endblock %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href={{ url_for("static", filename="css/booking.css") }}>
    <script type="text/javascript" src={{ url_for("static", filename="js/room.js") }}></script>
    <script type="text/javascript" src={{ url_for("static", filename="js/calendar.js") }}></script>
    <!--Load React and React DOM-->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <!-- Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
{% endblock %}
{% block content %}
<div class="search_wrap">
    <!--由Search組件渲染-->
</div>
<div class="calendar_wrap">
    <!--由Calendar組件渲染-->
</div>
<script type="text/babel">
    class Search extends React.Component{
        state={
            check_in_date: "",
            check_out_date: "",
            adults: 1,
            kids: 0
        }
        componentDidMount(){
            if(window.location.search==""){
                this.setState({
                    check_in_date: getDateString(),
                    check_out_date: getDateString(2)
                })
            }else{
                let search_sting = (location.search).replace("?", "").split("&");
                this.setState({
                    check_in_date: (search_sting[0].split("="))[1],
                    check_out_date: (search_sting[1].split("="))[1],
                    adults: (search_sting[2].split("="))[1],
                    kids: (search_sting[3].split("="))[1]
                })
            }
        }
        render(){
            return(
                <div id="booking">
                    <div class="check_in_date">
                        <p>Check In入住</p>
                        <input type="date" name="check_in_date" id="check_in_date" 
                            value={this.state.check_in_date} onChange={this.handleChange("check_in_date")}/>
                    </div>
                    <div class="check_out_date">
                        <p>Check Out退房</p>
                        <input type="date" name="check_out_date" id="check_out_date" 
                            value={this.state.check_out_date} onChange={this.handleChange("check_out_date")}/>
                    </div>
                    <div class="adults">
                        <p>Adults大人</p>
                        <input type="number" name="adults" id="adults" min="1" max="99" 
                            value={this.state.adults} onChange={this.handleChange("adults")}/>
                    </div>
                    <div class="kids">
                        <p>Kids小孩</p>
                        <input type="number" name="kids" id="kids" min="0" max="99" 
                            value={this.state.kids} onChange={this.handleChange("kids")}/>
                    </div>
                    <div class="submit">
                        <button type="submit" onClick={this.handleSubmit}>查詢</button>
                    </div>
                </div>
            )
        }
        handleChange=(dataType)=>{         
            return (eObj)=>{
                let thatDay_s = 0
                if(dataType=="check_in_date"){
                    let today_s = new Date(getDateString(0)).getTime()
                    thatDay_s = new Date(eObj.target.value).getTime()
                    if(today_s==thatDay_s){
                        alert("本日住宿，請電洽089-771-551")
                        return
                    }else if(today_s>thatDay_s){
                        alert("無效日期")
                        return
                    }
                }else if(dataType=="check_out_date"){
                    let nextDay_s = new Date(getDateString()).getTime()
                    thatDay_s = new Date(eObj.target.value).getTime()
                    if(nextDay_s>thatDay_s){
                        alert("無效日期")
                        return
                    }
                }
                this.setState({[dataType]: eObj.target.value})
            }
        }
        handleSubmit=()=>{
            const {check_in_date, check_out_date, adults, kids} = this.state
            if(new Date(check_out_date)>new Date(check_in_date)){
                let search_string = "checkin="+check_in_date+"&checkout="+check_out_date+"&adults="+adults+"&kids="+kids
                location.href = `${window.origin}/booking?${search_string}`
            }else{
                alert("退房日期必須晚於入住日期")
                return
            }
        }
    }
    class Calendar extends React.Component{
        state = {
            index: 1,
            rooms: [],
            y: "",
            m: "",
            week: [],
            booked: []
        }
        componentDidMount(){
            const first_search_sting = location.search.split("&")[0].split("?")[1].split("=");
            if(first_search_sting[0]=="checkin"){
                getWeeklyCalendar(first_search_sting[1]).then(respC=>{
                    const week = respC.data;
                    getBookingListByDate(week[0].date).then(respB=>{
                        const booked = respB.data;
                        this.setState({
                            rooms: this.props.rooms,
                            y: week[0].date.split("-")[0],
                            m: week[0].date.split("-")[1],
                            week,
                            booked
                        })
                    })
                })
            } 
        }
        render(){
            if(this.state.week.length>0){
                const tomorrow_string = getDateString();
            }
            return(
                <table>
                    <thead>
                        <tr>
                            <th colspan="9"><h2>{this.state.y} 年 - {this.state.m} 月</h2></th>
                        </tr>
                        <tr>
                            <td className="left_td">
                                <p><a href="javascript: void(0)" onClick={this.toNextPage(-7)}>上週</a></p>
                            </td>
                            {this.state.week.map(d=><Day data={d}/>)}
                            <td className="left_td">
                                <a href="javascript: void(0)" onClick={this.toNextPage(7)}>下週</a>
                            </td>
                        </tr>
                    </thead>
                    <tbody>
                        {this.state.rooms.map(r=><Row room={r} week={this.state.week}/>)}
                    </tbody>
                </table>
            )
        }
        toNextPage=(days)=>{
            return(eObj=>{
                console.log(days);
            })
        }
    }
    class Day extends React.Component{
        render(){
            const data = this.props.data;
            return(
                <th className={data.is_holiday && "holiday"}>
                    <h1>{((data.date).split("-"))[2]}</h1>
                    <p>{data.weekday}</p>
                </th>
            )
        }
    }
    class Row extends React.Component{
        render(){
            const room = this.props.room;
            const week = this.props.week;
            return(
                <tr>
                    <th>
                        {room.room_name}
                    </th>
                    {week.map(d=>(
                        <BookingItem id={`${d.date}-${room.room_no}`}/>
                        )
                    )}
                    <th>
                        {room.room_name}
                    </th> 
                </tr>
            )
        }
    }
    class BookingItem extends React.Component{
        render(){
            return(
                <td>
                    <a href="#">{this.props.id}</a>
                </td>
            )
        }
    }
    addEventListener("load", ()=>{
        ReactDOM.render(<Search/>, document.querySelector(".search_wrap"))
        if(window.location.search!==""){
            roomRequest().then(resp=>{
                if(resp.data){
                    ReactDOM.render(<Calendar rooms={resp.data}/>, document.querySelector(".calendar_wrap"))
                }
            })
        }
    })
</script>
{% endblock %}