{% extends "admin_base.html" %}
{% block title %}Order List{% endblock %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href={{ url_for("static", filename="css/order.css") }}>
    <script type="text/javascript" src={{ url_for("static", filename="js/order.js") }}></script>
{% endblock %}
{% block content %}
    <main>
        <nav>
            <!--ç”±Searchçµ„ä»¶æ¸²æŸ“-->
        </nav>
        <div id="databox">
            <!--ç”±DataBoxçµ„ä»¶æ¸²æŸ“-->
        </div>
    </main>
    <script type="text/babel">
        class DataBox extends React.Component{
            render(){
                let content;
                if(this.props.data.length>0){
                    content = this.props.data.map(d=><DataRow key={d.order_id} data={d}/>)
                }
                return(
                    <table className="table">
                        <thead>
                            <Thead />
                        </thead>
                        <tbody>
                            { content }
                        </tbody>
                    </table>
                )
            }
        }
        class Thead extends React.Component{
            state = {
                cols: [
                    {id: "order_id_col", name: "è¨‚å–®ç·¨è™Ÿ"},
                    {id: "create_datetime_col", name: "å»ºç«‹æ™‚é–“"},
                    {id: "date_col", name: "å…¥ä½ / é€€æˆ¿æ—¥æœŸ"},
                    {id: "nights_col", name: "å¤©æ•¸"},
                    {id: "guests_col", name: "äººæ•¸"},
                    {id: "amount_col", name: "ç¸½é‡‘é¡"},
                    {id: "booker_info_col", name: "è¨‚æˆ¿äºº"},
                    {id: "add_on_service_col", name: "é™„åŠ æœå‹™"},
                    {id: "order_status_col", name: "ç‹€æ…‹"}
                ]
            }
            render(){
                return(
                    <tr>
                        { this.state.cols.map(col=><th id={col.id}>{col.name}</th>) }
                    </tr>
                )
            }
        }
        class DataRow extends React.Component{
            state = {
                status_list: {
                    NEW: "æ–°è¨‚å–®",
                    PAID: "å·²ä»˜æ¬¾",
                    CANCEL: "å–æ¶ˆ"
                }
            }
            componentDidMount(){
                this.setState({
                    status: this.props.data.order_status
                })
            }
            render(){
                const data = this.props.data;
                const status = this.state.status;
                return(
                    <tr>
                        <td>{data.order_id}</td>
                        <td>{data.create_datetime}</td>
                        <td className="left_td">
                            <div>{data.check_in_date} / </div>
                            <div>{data.check_out_date}</div>
                            <div className="booking_detail">
                                <a href="#">ğŸ”½æˆ¿é–“æ˜ç´°ğŸ”¼</a>
                            </div>
                        </td>
                        <td>{data.nights}</td>
                        <td>{data.guests}</td>
                        <td>{data.amount}</td>
                        <td className="left_td">
                            <p>{data.booker_name} {data.booker_gender=="F"? "å°å§" : "å…ˆç”Ÿ"} {data.booker_phone}</p>
                            <PaymentInfo status={status} oid={data.order_id} pid={data.payment_id}/>
                        </td>
                        <td>{data.add_on_order_id}</td>
                        <td>
                            {this.state.status_list[status]}
                        </td>
                    </tr>
                )
            }

        }
        class PaymentInfo extends React.Component{
            state = {
                payment_status: {
                    NEW: "å¾…ç¢ºèª(ATM)",
                    PAID:  "è½‰å¸³å®Œæˆ",
                    CANCEL: "å–æ¶ˆ"
                },
                switchOn: false
            }
            render(){
                const status = this.props.status;
                return(
                    <div className="payment_div">
                        è¨‚é‡‘ï¼š
                        <span>
                            {this.state.payment_status[status]}
                        </span>
                        <button className={status=="PAID" && "paid_btn"} 
                            onClick={this.getPaymentDetail}>
                            {status=="PAID"? "ä»˜æ¬¾è³‡æ–™" : "ç¢ºèªè½‰å¸³"}
                        </button>
                        {this.state.switchOn && (
                            <div className="payment_detail" id={`payment_detail_${this.props.oid}`}>
                                <PaidForm oid={this.props.oid} pid={this.props.pid}/>
                            </div>
                        )}
                    </div>
                )
            }
            getPaymentDetail=()=>{
                this.setState({switchOn: !this.state.switchOn})
            }
        }
        class PaidForm extends React.Component{
            state = {
                bank: "", // éŠ€è¡Œ
                account_no_last_5_digits: "", //å¸³è™Ÿæœ«äº”ç¢¼
                name: "", // æˆ¶å
                amount: 0,
                date: ""
            }
            componentDidMount(){
                if(this.props.pid!==null){
                    console.log(this.props.pid);
                }
            }
            render(){
                return(
                    <form className="payment_form" id={`payment_form_${this.props.id}`}
                        onSubmit={this.handleSubmit}>
                        <div>
                            <label for="">åŒ¯æ¬¾éŠ€è¡Œï¼š</label>
                            <input type="text" value={this.state.bank} 
                                onChange={this.handleChange("bank")}/>
                        </div>
                        <div>
                            <label for="">å¸³è™Ÿæœ«äº”ç¢¼ï¼š</label>
                            <input type="text" value={this.state.account_no_last_5_digits} 
                                onChange={this.handleChange("account_no_last_5_digits")}/>
                        </div>
                        <div>
                            <label for="">åŒ¯æ¬¾æˆ¶åï¼š</label>
                            <input type="text" value={this.state.name} 
                                onChange={this.handleChange("name")}/>
                        </div>
                        <div>
                            <label for="">é‡‘é¡ï¼š</label>
                            <input type="text" value={this.state.amount} 
                                onChange={this.handleChange("amount")}/>
                        </div>
                        <div>
                            <label for="">åŒ¯æ¬¾æ—¥æœŸï¼š</label>
                            <input id="transfer_date_input" type="date" value={this.state.date} 
                                onChange={this.handleChange("date")}/>
                        </div>
                        {this.props.pid==null? (
                            <input type="submit" value="æäº¤"/>
                        ):(
                            <input className="update_btn" type="submit" value="ä¿®æ”¹"/>
                        )}
                    </form>
                )
            }
            handleChange=(dataType)=>{
                return(eObj=>{
                    this.setState({[dataType]: eObj.target.value})
                })
            }
            handleSubmit=(eObj)=>{
                eObj.preventDefault();
                const {bank, account_no_last_5_digits, name, amount, date} = this.state;
                let check_ok;
                if(bank=="" || account_no_last_5_digits=="" || name=="" || amount=="" || date==""){
                    alert("åŒ¯æ¬¾è³‡æ–™çš†ä¸å¾—ç‚ºç©º")
                    return
                }else if(account_no_last_5_digits.length<5){
                    alert("åŒ¯æ¬¾å¸³è™Ÿç¼ºç¢¼ï¼Œè«‹ç¢ºèª!!")
                    return
                }else{
                    let msg = `éŠ€è¡Œï¼š${bank}\nå¸³è™Ÿæœ«äº”ç¢¼ï¼š${account_no_last_5_digits}\næˆ¶åï¼š${name}\nè«‹å†æ¬¡ç¢ºèª?`
                    check_ok = confirm(msg);
                }
                if(check_ok){
                    console.log(this.state);
                }
            }
        }
        class Search extends React.Component{
            state = {
                order_status: "NEW", // NEW, ALL, PAID, CANCEL
                select: "",
                keyword: ""
            }
            componentDidMount(){
                let p;
                if(location.search){
                    const query_string = location.search.replace("?", "");
                    p = getOrdersByKeyword(query_string.split("=")[0], query_string.split("=")[1])
                    this.setState({
                        order_status: "ALL",
                        select: query_string.split("=")[0],
                        keyword: query_string.split("=")[1]
                    })
                }else if(location.pathname.split("/")[3]){
                    p = getOrderById(location.pathname.split("/")[3])
                    this.setState({
                        order_status: "ALL",
                        select: "order_id",
                        keyword: location.pathname.split("/")[3]
                    })
                }else if(location.pathname=="/admin/orders"){
                    p = getOrdersByStatus(this.state.order_status)
                }
                p.then(data=>{
                    ReactDOM.render(<DataBox data={data}/>, document.querySelector("#databox"));
                })
            }
            render(){
                return(
                    <div id="wrap">
                        <div id="status_wrap">
                            <label for="">è¨‚å–®ç‹€æ…‹</label>
                            <select value={this.state.order_status} onChange={this.filterStatus}>
                                <option value="new">æ–°è¨‚å–®</option>
                                <option value="all">å…¨éƒ¨è¨‚å–®</option>
                                <option value="paid">å·²ä»˜æ¬¾</option>
                                <option value="cancel">å–æ¶ˆ</option>
                            </select>
                        </div>
                        <div id="keyword_wrap">
                            <label for="">æœå°‹é …ç›®</label>
                            <select value={this.state.select} onChange={this.handleChange("select")}>
                                <option value="">è«‹é¸å–æœå°‹é …ç›®</option>
                                <option value="order_id">è¨‚å–®ç·¨è™Ÿ</option>
                                <option value="phone">è¯çµ¡é›»è©±</option>
                                <option value="check_in_date">å…¥ä½æ—¥æœŸ</option>
                            </select>
                            <input type={this.state.select=="check_in_date" ? "date" : "text"} name="keyword" id="keyword" placeholder="è«‹è¼¸å…¥é—œéµå­—"
                                value={this.state.keyword} onChange={this.handleChange("keyword")}/>
                            <button type="submit" className="btn btn-dark" onClick={this.handleSubmit}>æœå°‹</button>
                        </div>
                    </div>
                )
            }
            filterStatus=(eObj)=>{
                getOrdersByStatus(eObj.target.value).then(data=>{
                    ReactDOM.render(<DataBox data={data}/>, document.querySelector("#databox"));
                })
                this.setState({
                    order_status: eObj.target.value,
                    select: "",
                    keyword: ""
                })
            }
            handleChange=(dataType)=>{
                return(eObj=>{
                    this.setState({
                        [dataType]: eObj.target.value
                    });
                })
            }
            handleSubmit=(eObj)=>{
                if(this.state.select=="" || this.state.keyword==""){
                    alert("æœå°‹é …ç›®åŠé—œéµå­—çš†ä¸å¾—ç‚ºç©º")
                    return
                }else{
                    const data_type = this.state.select;
                    const keyword = this.state.keyword
                    if(data_type=="order_id"){
                        location.href = `/admin/order/${keyword}`
                    }else{
                        location.href = `/admin/orders?${data_type}=${keyword}`
                    }                    
                }
            }
        }
        addEventListener("load", ()=>{
            currentUserPromise.then(currentUser=>{
                // console.log(currentUser)
                if(currentUser!==null){
                    ReactDOM.render(<Banner id={currentUser[0]} name={currentUser[1]}/>, document.querySelector("header"));
                    ReactDOM.render(<Search />, document.querySelector("nav"));
                }else{
                    location.href = `${window.origin}/admin/`
                }
            })
        })
    </script>
{% endblock %}