{% extends "admin_base.html" %}
{% block title %}Order List{% endblock %}
{% block head %}
    {{ super() }}

    <style>
        #search_wrap{
            max-width: 95%;
            margin: auto;
        }
        #databox_wrap{
            max-width: 95%;
            margin: auto;
        }
    </style>
{% endblock %}
{% block content %}
    <div id="search_wrap" class="container">
        <!--由Search組件渲染-->
        <div class="row my-3">
            <div class="col-1"></div>
            <div class="col-3">
                <div class="input-group mt-3">
                    <label class="input-group-text bg-secondary text-white" for="inputStatusSelect">訂單狀態</label>
                    <select class="form-select" id="inputStatusSelect">
                        <option value="all">全部訂單</option>
                        <option value="new">新訂單</option>
                        <option value="pending">待確認</option>
                        <option value="paid">已付款</option>
                    </select>
                </div>
            </div>
            <div class="col-2"></div>
            <div class="col-5">
                <div class="input-group mt-3">
                    <select class="form-select" id="inputGroupSelect">
                        <option selected>請選取搜尋項目</option>
                        <option value="order_id">訂單編號</option>
                        <option value="phone">訂房電話</option>
                        <option value="check_in_date">入住日期</option>
                    </select>
                    <input type="text" class="form-control" name="keyword" id="keyword" placeholder="請輸入關鍵字">
                    <button class="btn btn-outline-primary" type="button">搜尋</button>
                    </div>
                </div>
            </div>
            <div class="col-1"></div>
        </div>
    </div>
    <div id="databox_wrap">
        <!--由DataBox組件渲染-->
        <div class="table-responsive-xl">
            <table class="table text-center my-3">
                <thead>
                    <tr>
                        <th scope="col">訂單編號</th>
                        <th scope="col">建立時間</th>
                        <th scope="col">入住 / 退房日期</th>
                        <th scope="col">天數</th>
                        <th scope="col">人數</th>
                        <th scope="col">總金額</th>
                        <th scope="col">訂房 / 付款資訊</th>
                        <th scope="col">狀態</th>
                    </tr>
                </thead>
                <tbody style="line-height: 1.8;">
                    {% if orders %}
                        {% for order in orders %}
                            <!--已付款-->
                            {% if order.status.value=="PAID" %}
                            <tr class="bg-paid">
                                <td scope="row">{{ order.oid }}</th>
                                <td>{{ order.create_datetime }}</td>
                                <td>
                                    {{ order.detail.check_in_date }} / {{ order.detail.check_out_date }}
                                    <br>
                                    {% if order.detail %}
                                    {{ order.detail.room.name }}
                                    {% endif %}
                                </td>
                                <td>{{ order.detail.nights }}</td>
                                <td>{{ order.detail.num_of_guests }}</td>
                                <td>{{ order.amount }}</td>
                                <td>
                                    {{ order.detail.booker_name }} | {{ order.detail.booker_phone }}
                                    <div class="mt-2">
                                        付款：<span class="text-success fw-bold">轉帳完成</span>
                                        <button type="button" class="btn btn-sm btn-outline-success fw-bold mx-1">查看資料</button>
                                    </div>
                                </td>
                                <td class="fw-bold">
                                    已付款
                                </td>
                            </tr>
                            <!--新訂單-->
                            {% elif order.status.value=="NEW" %}
                            <tr class="bg-new">
                                <td scope="row">{{ order.oid }}</th>
                                <td>{{ order.create_datetime }}</td>
                                <td>
                                    {{ order.detail.check_in_date }} / {{ order.detail.check_out_date }}
                                    <br>
                                    {% if order.detail %}
                                    {{ order.detail.room.name }}
                                    {% endif %}
                                </td>
                                <td>{{ order.detail.nights }}</td>
                                <td>{{ order.detail.num_of_guests }}</td>
                                <td>{{ order.amount }}</td>
                                <td>
                                    {{ order.detail.booker_name }} | {{ order.detail.booker_phone }}
                                    <div class="mt-2">
                                        付款：<span class="text-decoration-none text-primary">{{ order.payment_deadline }}</span>
                                        <button type="button" class="btn btn-sm btn-outline-primary fw-bold mx-1">確認匯款</button>
                                    </div>
                                </td>
                                <td class="fw-bold">
                                    新訂單
                                    <br>
                                    <button type="button" class="btn btn-sm btn-outline-dark fw-bold mt-2" id="cancel_btn_{{ order.oid }}">取消</button>
                                </td>
                            </tr>
                            <!--待確認-->
                            {% elif order.status.value=="PENDING" %}
                            <tr class="bg-pending">
                                <td scope="row">{{ order.oid }}</th>
                                <td>{{ order.create_datetime }}</td>
                                <td>
                                    {{ order.detail.check_in_date }} / {{ order.detail.check_out_date }}
                                    <br>
                                    {% if order.detail %}
                                    {{ order.detail.room.name }}
                                    {% endif %}
                                </td>
                                <td>{{ order.detail.nights }}</td>
                                <td>{{ order.detail.num_of_guests }}</td>
                                <td>{{ order.amount }}</td>
                                <td>
                                    {{ order.detail.booker_name }} | {{ order.detail.booker_phone }}
                                    <div class="mt-2">
                                        付款：<span class="text-decoration-none text-primary">{{ order.payment_deadline }}</span>
                                        <button type="button" class="btn btn-sm btn-outline-primary fw-bold mx-1">確認匯款</button>
                                    </div>
                                </td>
                                <td class="fw-bold text-primary">
                                    待確認
                                    <br>
                                    <button type="button" class="btn btn-sm btn-outline-dark fw-bold mt-2" id="cancel_btn_{{ order.oid }}">取消</button>
                                </td>
                            </tr>
                            <!--取消-->
                            {% elif order.status.value=="CANCEL" %}
                            <tr class="text-muted">
                                <td scope="row">{{ order.oid }}</th>
                                <td>{{ order.create_datetime }}</td>
                                <td>
                                    {{ order.detail.check_in_date }} / {{ order.detail.check_out_date }}
                                    <br>
                                    {% if order.detail %}
                                    {{ order.detail.room.name }}
                                    {% endif %}
                                </td>
                                <td>{{ order.detail.nights }}</td>
                                <td>{{ order.detail.num_of_guests }}</td>
                                <td>{{ order.amount }}</td>
                                <td class="fst-italic">
                                    {{ order.detail.booker_name }} | {{ order.detail.booker_phone }}
                                    <div>
                                        付款：<span>已取消</span>
                                    </div>
                                </td>
                                <td class="fw-bold">
                                    取消
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    <script type="text/babel">
        const cancel_btns = document.querySelectorAll("button[id^='cancel_btn_']");
        document.querySelectorAll("button[id^='cancel_btn_']").forEach(btn=>{
            const id = btn.id.split("_")[2];
            btn.addEventListener("click", cancelOrderById);
        })
        function cancelOrderById(eObj){
            //console.log(csrf_token);
            const oid = eObj.target.id.split("_")[2];
            const url = `${window.origin}/admin/order/${oid}`;
            fetch(`${window.origin}/admin/order/${oid}`, {
                method: "delete",
                credentials: "include",
                headers: {"X-CSRFToken": csrf_token}
            }).then(response=>{
                if(response.status==200){
                    location.href = "/admin/order";
                }else{
                    console.log(response.json())
                }
            })
        }
        class PaidForm extends React.Component{
            state = {
                bank: "", // 銀行
                account_no: "", //帳號至先五碼
                name: "", // 戶名
                amount: "",
                transfer_date: "",
                past_data: {}, // 存放原始資料，以追蹤修改項目
            }
            labels = {
                bank: "匯款銀行", 
                account_no: "帳號末五碼", 
                name: "匯款戶名", 
                amount: "金額",
                transfer_date: "匯款日期"
            }
            componentDidMount(){
                if(this.props.pid!==null){
                    getPayment(this.props.pid).then(resp=>{
                        this.setState({
                            bank: resp.data.bank,
                            account_no: resp.data.account_no,
                            name: resp.data.name,
                            amount: resp.data.amount,
                            transfer_date: resp.data.transfer_date,
                            past_data: resp.data
                        })
                    })
                }
            }
            render(){
                // console.log(this.props.cancel);
                let payment_content = []
                Object.keys(this.labels).forEach(col=>{
                    let item = (
                        <div>
                            <label for="">{this.labels[col]}：</label>
                            <input type={col=="transfer_date"? "date" : "text"} id={`${col}_input`} value={this.state[col]} 
                                onChange={this.handleChange(col)} required/>
                        </div>
                    )
                    payment_content.push(item)
                })
                return(
                    <form className="payment_form" id={`payment_form_${this.props.oid}`}
                        onSubmit={this.props.pid!==null? this.handleUpdate : this.handleCreate}>
                        { payment_content }
                        {this.props.pid===null? (
                            <input type="submit" value="提交"/>
                        ):(
                            <input className="update_btn" type="submit" value="修改"/>
                        )}
                    </form>
                )
            }
            handleChange=(dataType)=>{
                return(eObj=>{
                    let value = eObj.target.value;
                    if(dataType==="amount"){
                        value = parseInt(eObj.target.value);
                    }
                    this.setState({[dataType]: value})
                })
            }
            checkInputValue=(msg)=>{
                // console.log(this.state);
                const {bank, account_no, name, amount, transfer_date} = this.state;
                if(account_no.length<5){
                    alert("匯款帳號缺碼，請確認!!")
                    return
                }else if(typeof amount!=="number" || amount<0){
                    alert("請輸入阿拉伯數字")
                    return
                }else{
                    let check = confirm(msg)
                    return check
                }
            }
            handleCreate=(eObj)=>{
                eObj.preventDefault();
                const state = this.state;
                let msg = "";
                Object.keys(this.labels).forEach(col=>{
                    msg = msg+ `${this.labels[col]}：${state[col]}\n`
                })
                msg = msg +`再次確認?`
                const check = this.checkInputValue(msg);
                if(check){
                    delete state.past_data;
                    createNewPayment(this.props.oid, state).then(resp=>{
                        if(resp.ok){
                            alert("新增完成")
                            location.href = `/admin/order?id=${this.props.oid}`
                        }
                    })
                }
            }
            handleUpdate=(eObj)=>{
                eObj.preventDefault();
                const state = this.state;
                let msg = "";
                let data = {};
                Object.keys(this.labels).forEach(col=>{
                    if(state[col]!==state.past_data[col]){
                        msg = msg+ `${this.labels[col]}：${state[col]}\n`
                        data[col] = state[col]
                    }
                })
                if(msg!=="" && data!=={} && this.props.pid!==null){
                    msg = msg +`是否確定修改?`
                    const check = this.checkInputValue(msg);
                    if(check){
                        updatePayment(this.props.pid, data).then(resp=>{
                            if(resp.ok){
                                alert("修改完成")
                                location.href = `/admin/order?id=${this.props.oid}`
                            }
                        })
                    }
                }
            }
        }
    </script>
{% endblock %}